name: Simulation Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  simulation-tests:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install numpy pytest

      - name: Run network emulator tests
        run: |
          python3 tests/simulation/network_emulator.py

      - name: Run environment tier tests
        run: |
          python3 tests/simulation/environment_tiers.py

      - name: Run ROS topic integration tests
        run: |
          python3 tests/integration/test_ros_topic_comprehensive.py || true

      - name: Run comprehensive simulation tests
        run: |
          python3 tests/simulation/comprehensive_simulation_tests.py || true

      - name: Generate test reports
        run: |
          python3 tests/reporting/simulation_reporter.py

      - name: Upload test reports
        uses: actions/upload-artifact@v3
        with:
          name: simulation-test-reports
          path: |
            tests/reports/simulation_test_report.json
            tests/reports/simulation_test_report.html
            tests/reports/simulation_test_summary.md

      - name: Check simulation coverage
        run: |
          python3 -c "
          import json
          from pathlib import Path

          report_file = Path('tests/reports/simulation_test_report.json')
          if not report_file.exists():
              print('‚ö†Ô∏è No report file found, skipping coverage check')
              exit(0)

          with open(report_file) as f:
              report = json.load(f)

          summary = report.get('summary', {})
          total = summary.get('total_tests', 0)
          passed = summary.get('passed', 0)
          pass_rate = summary.get('pass_rate', 0)

          print(f'üìä Test Summary:')
          print(f'   Total: {total}')
          print(f'   Passed: {passed}')
          print(f'   Pass Rate: {pass_rate:.1f}%')

          # Check hardware validation
          validation = report.get('validation_status', {})
          hw_percent = validation.get('hardware_coverage_percent', 0)

          print(f'')
          print(f'‚úÖ Hardware Validation: {hw_percent:.1f}%')

          if hw_percent < 10:
              print(f'‚ö†Ô∏è  WARNING: Less than 10% hardware validation')
              print(f'   This is expected for simulation-only tests')

          print(f'')
          print(f'üö® REMINDER: All tests are simulation-based')
          print(f'   Hardware validation required before deployment')
          "

      - name: Comment test summary on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportFile = 'tests/reports/simulation_test_report.json';

            if (!fs.existsSync(reportFile)) {
              console.log('No report file found, skipping comment');
              return;
            }

            const report = JSON.parse(fs.readFileSync(reportFile));
            const summary = report.summary || {};
            const validation = report.validation_status || {};

            const body = `
            ## üß™ Simulation Test Results

            **Overall:** ${summary.passed}/${summary.total_tests} passed (${summary.pass_rate?.toFixed(1)}%)

            ### By Environment Tier:
            ${Object.entries(report.by_environment_tier || {}).map(([tier, data]) =>
              `- **${tier}**: ${data.passed}/${data.total} passed`
            ).join('\n')}

            ### Hardware Validation Status:
            - **Hardware Validated:** ${validation.hardware_validated}/${validation.total_tests} (${validation.hardware_coverage_percent?.toFixed(1)}%)
            - **Status:** ${validation.status?.replace(/_/g, ' ')}

            ### ‚ö†Ô∏è Important Notice:
            ${report.simulation_warning || 'All tests are simulation-based'}

            [üìä View Full Report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
