# Docker Compose for Complete Testing Environment
# Best practices: Isolated networks, health checks, resource limits
# Usage: docker-compose -f docker/docker-compose.test.yml up --abort-on-container-exit

version: "3.8"

services:
  # ==================================================
  # ROS2 Core (required for all tests)
  # ==================================================
  ros2-core:
    image: ros:humble-ros-core
    container_name: urc2026-test-ros2-core
    environment:
      - ROS_DOMAIN_ID=42
      - URC_ENV=testing
    healthcheck:
      test: ["CMD", "ros2", "node", "list"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - test-network
    restart: unless-stopped

  # ==================================================
  # Unit Test Runner
  # ==================================================
  unit-tests:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
      target: test-runner
    container_name: urc2026-unit-tests
    environment:
      - PYTHONPATH=/home/urc
      - ROS_DOMAIN_ID=42
      - URC_ENV=testing
      - PYTEST_CURRENT_TEST=unit
    volumes:
      - ../test_results:/home/urc/test_results
      - ../test_reports:/home/urc/test_reports
    command: ["python3", "-m", "pytest", "tests/unit/", "-v", "--tb=short", "--junitxml=/home/urc/test_results/unit-junit.xml", "--cov=src", "--cov-report=html:/home/urc/test_reports/unit-coverage", "--cov-report=term"]
    depends_on:
      ros2-core:
        condition: service_healthy
    networks:
      - test-network
    profiles:
      - unit
      - all

  # ==================================================
  # Integration Test Runner
  # ==================================================
  integration-tests:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
      target: integration-test
    container_name: urc2026-integration-tests
    environment:
      - PYTHONPATH=/home/urc
      - ROS_DOMAIN_ID=42
      - URC_ENV=testing
      - PYTEST_CURRENT_TEST=integration
    volumes:
      - ../test_results:/home/urc/test_results
      - ../test_reports:/home/urc/test_reports
    command: ["python3", "-m", "pytest", "tests/integration/", "-v", "--tb=short", "--junitxml=/home/urc/test_results/integration-junit.xml", "--cov=src", "--cov-report=html:/home/urc/test_reports/integration-coverage", "-k", "not hardware"]
    depends_on:
      ros2-core:
        condition: service_healthy
    networks:
      - test-network
    profiles:
      - integration
      - all

  # ==================================================
  # Simulation Test Runner
  # ==================================================
  simulation-tests:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
      target: simulation-test
    container_name: urc2026-simulation-tests
    environment:
      - PYTHONPATH=/home/urc
      - ROS_DOMAIN_ID=42
      - URC_ENV=testing
      - DISPLAY=:99
      - GAZEBO_MASTER_URI=http://localhost:11345
    volumes:
      - ../test_results:/home/urc/test_results
      - ../test_reports:/home/urc/test_reports
    command: ["python3", "-m", "pytest", "tests/integration/test_ros2_simulation_integration.py", "tests/integration/test_complete_communication_stack.py", "tests/simulation_integration_suite.py", "-v", "--tb=short", "--junitxml=/home/urc/test_results/simulation-junit.xml"]
    depends_on:
      ros2-core:
        condition: service_healthy
    networks:
      - test-network
    privileged: true  # Required for Gazebo
    profiles:
      - simulation
      - all

  # ==================================================
  # Performance Test Runner
  # ==================================================
  performance-tests:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
      target: test-runner
    container_name: urc2026-performance-tests
    environment:
      - PYTHONPATH=/home/urc
      - ROS_DOMAIN_ID=42
      - URC_ENV=testing
      - PYTEST_CURRENT_TEST=performance
    volumes:
      - ../test_results:/home/urc/test_results
      - ../test_reports:/home/urc/test_reports
    command: ["python3", "-m", "pytest", "tests/performance/", "-v", "--tb=short", "--benchmark-only", "--junitxml=/home/urc/test_results/performance-junit.xml"]
    depends_on:
      ros2-core:
        condition: service_healthy
    networks:
      - test-network
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "2.0"
    profiles:
      - performance
      - all

  # ==================================================
  # Complete Test Suite Runner
  # ==================================================
  all-tests:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
      target: test-runner
    container_name: urc2026-all-tests
    environment:
      - PYTHONPATH=/home/urc
      - ROS_DOMAIN_ID=42
      - URC_ENV=testing
    volumes:
      - ../test_results:/home/urc/test_results
      - ../test_reports:/home/urc/test_reports
    command: ["python3", "-m", "pytest", "tests/", "-v", "--tb=short", "-k", "not hardware", "--junitxml=/home/urc/test_results/all-junit.xml", "--cov=src", "--cov-report=html:/home/urc/test_reports/all-coverage", "--cov-report=term"]
    depends_on:
      ros2-core:
        condition: service_healthy
    networks:
      - test-network
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "2.0"
    profiles:
      - all

networks:
  test-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16

volumes:
  test_results:
    driver: local
  test_reports:
    driver: local
