# Test Environment Dockerfile for URC 2026
# Best practices: Multi-stage, layer caching, security, testing
# Build with: docker build --target test-runner -t urc2026:test .

# ==================================================
# Stage 1: Base with dependencies (cached layer)
# ==================================================
FROM ros:humble-ros-base AS base

# Metadata labels (best practice)
LABEL maintainer="URC 2026 Team"
LABEL description="URC 2026 Robotics Platform - Test Environment"
LABEL version="1.0.0"

# Install system dependencies in single layer (caching optimization)
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3-pip \
    python3-dev \
    python3-setuptools \
    python3-venv \
    git \
    curl \
    wget \
    net-tools \
    iproute2 \
    can-utils \
    iputils-ping \
    dnsutils \
    build-essential \
    cmake \
    pkg-config \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Upgrade pip and install dependency parser (cached layer)
RUN pip3 install --no-cache-dir --upgrade pip setuptools wheel tomli

# Create non-root user early (security best practice)
RUN useradd --create-home --shell /bin/bash --groups dialout --uid 1000 urc && \
    echo 'urc:urc2026' | chpasswd

# Set environment variables
ENV PYTHONPATH=/home/urc
ENV ROS_DOMAIN_ID=42
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

USER urc
WORKDIR /home/urc

# ==================================================
# Stage 2: Dependencies installation (cached if pyproject.toml unchanged)
# ==================================================
FROM base AS dependencies

# Copy only dependency file (layer caching optimization)
COPY --chown=urc pyproject.toml ./

# Install Python dependencies (this layer is cached if pyproject.toml doesn't change)
RUN python3 -c "import tomli; f=open('pyproject.toml','rb'); d=tomli.load(f); deps=d.get('project',{}).get('dependencies',[]); [print(d) for d in deps if not d.strip().startswith('#') and not d.strip().startswith('Note:')]" > /tmp/requirements.txt && \
    pip3 install --no-cache-dir -r /tmp/requirements.txt 2>&1 | tee /tmp/install.log || (echo "Install had issues, checking..." && cat /tmp/install.log | tail -30) && \
    pip3 install --no-cache-dir orjson>=3.9.0 pydantic>=2.0.0 pydantic-settings>=2.0.0 pyserial>=3.5 || echo "Additional deps install check"

# Install test dependencies
RUN pip3 install --no-cache-dir \
    pytest>=7.0.0 \
    pytest-cov>=4.0.0 \
    pytest-asyncio>=0.21.0 \
    pytest-xdist>=3.3.0 \
    pytest-timeout>=2.1.0 \
    pytest-mock>=3.11.0 \
    pytest-benchmark>=4.0.0 \
    coverage[toml]>=7.2.0 \
    black>=22.0.0 \
    isort>=5.10.0 \
    flake8>=4.0.0 \
    mypy>=1.0.0 \
    py-trees>=0.8.0 \
    aiohttp>=3.8.0 \
    opencv-python>=4.8.0 \
    structlog>=22.0.0

# ==================================================
# Stage 3: Test runner with all code
# ==================================================
FROM dependencies AS test-runner

# Copy source code (this layer invalidates on code changes)
COPY --chown=urc src/ ./src/
COPY --chown=urc tests/ ./tests/
COPY --chown=urc missions/ ./missions/
COPY --chown=urc config/ ./config/
COPY --chown=urc simulation/ ./simulation/
COPY --chown=urc scripts/ ./scripts/
COPY --chown=urc setup.cfg ./setup.cfg

# Build ROS2 workspace in Docker
# Note: ROS2 packages will be built at runtime or can be pre-built
# For testing, we'll build on-demand or use pre-built packages
USER root
RUN mkdir -p /home/urc/src/build /home/urc/src/install /home/urc/src/log
USER urc

# Create test output directory
RUN mkdir -p /home/urc/test_results /home/urc/test_reports

# Health check for test environment
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python3 -c "import pytest; print('Test environment OK')" || exit 1

# Default command: run all tests
CMD ["python3", "-m", "pytest", "tests/", "-v", "--tb=short", "--junitxml=/home/urc/test_results/junit.xml", "--cov=src", "--cov-report=html:/home/urc/test_reports/coverage", "--cov-report=term"]

# ==================================================
# Stage 4: Simulation test environment
# ==================================================
FROM dependencies AS simulation-test

# Install Gazebo and simulation dependencies
USER root
RUN apt-get update && apt-get install -y --no-install-recommends \
    gazebo \
    ros-humble-gazebo-ros-pkgs \
    ros-humble-gazebo-ros \
    ros-humble-xacro \
    python3-colcon-common-extensions \
    xvfb \
    x11vnc \
    fluxbox \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

USER urc

# Copy simulation-specific code
COPY --chown=urc src/ ./src/
COPY --chown=urc tests/ ./tests/
COPY --chown=urc simulation/ ./simulation/
COPY --chown=urc config/ ./config/
COPY --chown=urc scripts/ ./scripts/

# Set Gazebo environment
ENV GAZEBO_MODEL_PATH=/home/urc/simulation/models:$GAZEBO_MODEL_PATH
ENV GAZEBO_PLUGIN_PATH=/home/urc/simulation/plugins:$GAZEBO_PLUGIN_PATH
ENV DISPLAY=:99

# Health check for simulation
HEALTHCHECK --interval=30s --timeout=15s --start-period=30s --retries=3 \
    CMD python3 -c "import gazebo_msgs; print('Simulation OK')" || exit 1

# Default command: run simulation tests
CMD ["python3", "-m", "pytest", "tests/integration/test_ros2_simulation_integration.py", "tests/integration/test_complete_communication_stack.py", "-v", "--tb=short"]

# ==================================================
# Stage 5: Integration test runner
# ==================================================
FROM dependencies AS integration-test

# Copy all code for integration testing
COPY --chown=urc . .

# Create test directories
RUN mkdir -p /home/urc/test_results /home/urc/test_reports

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python3 -c "import rclpy; print('Integration test environment OK')" || exit 1

# Default command: run integration tests
CMD ["python3", "-m", "pytest", "tests/integration/", "-v", "--tb=short", "--junitxml=/home/urc/test_results/integration-junit.xml", "--cov=src", "--cov-report=html:/home/urc/test_reports/integration-coverage"]
